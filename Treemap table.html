<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Plotly Treemap + DataTable Filter</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 10px;
      display: grid;
      grid-template-rows: 60% 40%;
      height: 100vh;
    }
    #chart {
      width: 100%;
      height: 100%;
    }
    table {
      width: 100%;
    }
  </style>
</head>
<body>

  <div id="chart"></div>
  <table id="dataTable" class="display"></table>

  <script>
    const data = [
      { system: "Boiler", subsystem: "Pump", item: "Pump A", duration: 5, complete: true },
      { system: "Boiler", subsystem: "Pump", item: "Pump B", duration: 8, complete: false },
      { system: "Boiler", subsystem: "Valve", item: "Valve A", duration: 3, complete: true },
      { system: "Turbine", subsystem: "Rotor", item: "Rotor A", duration: 10, complete: false },
      { system: "Turbine", subsystem: "Casing", item: "Casing A", duration: 6, complete: true },
      { system: "Cooling", subsystem: "Fan", item: "Fan A", duration: 4, complete: false }
    ];

    // --- Initialize DataTable ---
    const table = $('#dataTable').DataTable({
      data: data,
      columns: [
        { data: 'system', title: 'System' },
        { data: 'subsystem', title: 'Subsystem' },
        { data: 'item', title: 'Item' },
        { data: 'duration', title: 'Duration' },
        { data: 'complete', title: 'Complete', render: d => d ? "✅" : "❌" }
      ]
    });

    // --- Build Plotly Treemap ---
    function drawTreemap(filteredData) {
      const labels = [], parents = [], values = [], colors = [];

      const colorScale = d => d ? 'mediumseagreen' : 'lightcoral';

      // Build hierarchy manually
      const systems = [...new Set(filteredData.map(d => d.system))];
      systems.forEach(sys => {
        const sysItems = filteredData.filter(d => d.system === sys);
        labels.push(sys);
        parents.push("");
        values.push(sysItems.reduce((sum, d) => sum + d.duration, 0));
        colors.push("#ccc");

        const subsystems = [...new Set(sysItems.map(d => d.subsystem))];
        subsystems.forEach(sub => {
          const subItems = sysItems.filter(d => d.subsystem === sub);
          labels.push(sub);
          parents.push(sys);
          values.push(subItems.reduce((sum, d) => sum + d.duration, 0));
          colors.push("#aaa");

          subItems.forEach(item => {
            labels.push(item.item);
            parents.push(sub);
            values.push(item.duration);
            colors.push(colorScale(item.complete));
          });
        });
      });

      const trace = {
        type: "treemap",
        labels, parents, values,
        marker: { colors },
        hovertemplate: "<b>%{label}</b><br>Duration: %{value}<extra></extra>"
      };

      const layout = {
        margin: { t: 20, l: 0, r: 0, b: 0 },
      };

      Plotly.newPlot("chart", [trace], layout);

      // --- Click handler to filter table ---
      document.getElementById('chart').on('plotly_click', (event) => {
        const label = event.points[0].label;
        const filtered = data.filter(d =>
          d.system === label || d.subsystem === label || d.item === label
        );
        if (filtered.length > 0) {
          table.clear().rows.add(filtered).draw();
        }
      });
    }

    // Initial draw
    drawTreemap(data);

    // --- Table filtering -> update treemap dynamically ---
    $('#dataTable').on('search.dt', function() {
      const filteredData = table.rows({ filter: 'applied' }).data().toArray();
      drawTreemap(filteredData);
    });
  </script>

</body>
</html>
