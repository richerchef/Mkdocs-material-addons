<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Maintenance Dashboard</title>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<style>
body { font-family: sans-serif; margin:0; display:grid; grid-template-rows:auto 60% 40%; height:100vh; background:#f5f5f5; }
#controls { display:flex; justify-content:space-between; align-items:center; padding:10px; background:white; border-bottom:1px solid #ddd; }
#chart { width:100%; height:100%; background:white; }
#table-container { padding:10px; background:white; overflow:auto; }
.summary { font-weight:600; }
.dataTables_filter { display:none; } /* hide global search, we will use column filters */
</style>
</head>
<body>

<div id="controls">
  <div>
    <label>Colour by: </label>
    <select id="colorMode">
      <option value="complete">Completion Status</option>
      <option value="duration">Duration</option>
    </select>
  </div>
  <div class="summary" id="summary"></div>
</div>

<div id="chart"></div>
<div id="table-container">
  <table id="maintenanceTable" class="display" style="width:100%">
    <thead>
      <tr>
        <th>System</th>
        <th>Subsystem</th>
        <th>Item</th>
        <th>Duration</th>
        <th>Complete</th>
        <th>Priority</th>
        <th>Location</th>
      </tr>
      <tr id="filterRow">
        <th><input type="text" placeholder="Filter System"></th>
        <th><input type="text" placeholder="Filter Subsystem"></th>
        <th><input type="text" placeholder="Filter Item"></th>
        <th><input type="text" placeholder="Filter Duration"></th>
        <th><input type="text" placeholder="Filter Complete"></th>
        <th><input type="text" placeholder="Filter Priority"></th>
        <th><input type="text" placeholder="Filter Location"></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
// Example data - replace with your Python JSON export
const data = [
  { Universal_Identifier:"UID001", system: "Boiler", subsystem: "Pump", item: "Pump A", duration: 5, complete: true, priority:"High", location:"Zone 1" },
  { Universal_Identifier:"UID002", system: "Boiler", subsystem: "Pump", item: "Pump B", duration: 8, complete: false, priority:"Medium", location:"Zone 2" },
  { Universal_Identifier:"UID003", system: "Boiler", subsystem: "Valve", item: "Valve A", duration: 3, complete: true, priority:"Low", location:"Zone 1" },
  { Universal_Identifier:"UID004", system: "Turbine", subsystem: "Rotor", item: "Rotor A", duration: 10, complete: false, priority:"High", location:"Zone 3" }
];

// Initialize DataTable
const table = $('#maintenanceTable').DataTable({
  data: data,
  columns:[
    { data:"system" },
    { data:"subsystem" },
    { data:"item" },
    { data:"duration" },
    { data:"complete", render: d=>d ? "Yes" : "No" },
    { data:"priority" },
    { data:"location" }
  ],
  orderCellsTop:true,
  fixedHeader:true
});

// Column filters
$('#maintenanceTable thead tr#filterRow th').each(function(i){
  $('input', this).on('keyup change', function(){
    if(table.column(i).search() !== this.value){
      table.column(i).search(this.value).draw();
      updateTreemapFromTable();
    }
  });
});

// Summary counts
function updateSummary(currentData){
  const completeItems = currentData.filter(d=>d.complete);
  const outstandingItems = currentData.filter(d=>!d.complete);
  const summary = `
    Complete: ${completeItems.length} tasks (${completeItems.reduce((a,d)=>a+d.duration,0)} days) |
    Outstanding: ${outstandingItems.length} tasks (${outstandingItems.reduce((a,d)=>a+d.duration,0)} days)
  `;
  $('#summary').text(summary);
}

// Draw treemap
function drawTreemap(filteredData, colorMode="complete"){
  updateSummary(filteredData);

  const labels=[], parents=[], values=[], colors=[], hovertexts=[];
  const systems = [...new Set(filteredData.map(d=>d.system))];

  systems.forEach(sys=>{
    const sysItems = filteredData.filter(d=>d.system===sys);
    labels.push(sys); parents.push(""); values.push(sysItems.reduce((sum,d)=>sum+d.duration,0)); colors.push("#ccc"); hovertexts.push("");

    const subsystems = [...new Set(sysItems.map(d=>d.subsystem))];
    subsystems.forEach(sub=>{
      const subItems = sysItems.filter(d=>d.subsystem===sub);
      labels.push(sub); parents.push(sys); values.push(subItems.reduce((sum,d)=>sum+d.duration,0)); colors.push("#aaa"); hovertexts.push("");

      subItems.forEach(item=>{
        labels.push(item.Universal_Identifier);  // Use unique ID for Plotly labels
        parents.push(sub);
        values.push(item.duration);

        if(colorMode==="complete") colors.push(item.complete ? "mediumseagreen" : "lightcoral");
        else {
          const min = Math.min(...filteredData.map(d=>d.duration));
          const max = Math.max(...filteredData.map(d=>d.duration));
          const ratio = (item.duration - min)/(max-min||1);
          const r = Math.round(255*ratio);
          const g = Math.round(255*(1-ratio));
          colors.push(`rgb(${r},${g},0)`);
        }

        hovertexts.push(`
          <b>${item.item}</b><br>
          System: ${item.system}<br>
          Subsystem: ${item.subsystem}<br>
          Duration: ${item.duration} days<br>
          Complete: ${item.complete ? "Yes":"No"}<br>
          Priority: ${item.priority || ""}<br>
          Location: ${item.location || ""}
        `);
      });
    });
  });

  Plotly.newPlot("chart",[{
    type:"treemap",
    labels: labels,
    parents: parents,
    values: values,
    marker:{colors},
    branchvalues:"total",
    hoverinfo:"text",
    hovertext:hovertexts
  }]);

  // Click treemap to filter table
  document.getElementById("chart").on("plotly_click", e=>{
    const label = e.points[0].label;
    const filtered = data.filter(d=>d.Universal_Identifier===label || d.system===label || d.subsystem===label);
    table.clear().rows.add(filtered.length ? filtered : data).draw();
    updateSummary(filtered.length ? filtered : data);
    $('#maintenanceTable thead tr#filterRow input').val('');  // reset filters
  });
}

// Update treemap from table filtering
function updateTreemapFromTable(){
  const filteredData = table.rows({filter:'applied'}).data().toArray();
  drawTreemap(filteredData, $('#colorMode').val());
}

// Colour mode dropdown
$('#colorMode').on('change', function(){
  updateTreemapFromTable();
});

// Initial render
drawTreemap(data);
</script>

</body>
</html>
